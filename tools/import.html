<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Импорт Excel → data/tos.data.js</title>
  <meta name="description" content="Локальный инструмент: импорт Excel/CSV в формат каталога ТОС для статического сайта."/>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="/assets/css/styles.css"/>
</head>
<body>
  <a class="skip-link" href="#main">Перейти к содержимому</a>

  <header class="header">
    <div class="container header-inner">
      <a class="brand" href="/"><img src="/assets/img/logo.svg" alt="ТОС БГО"/></a>
      <nav class="nav" id="site-nav" aria-label="Навигация">
        <a href="/tos/">Каталог ТОС</a><a href="/news/">Новости</a><a href="/materials/">Материалы</a><a href="/documents/">Документы</a><a href="/map/">Карта</a><a href="/contacts/">Контакты</a>
      </nav>
      <div class="actions">
        <button class="btn menu-btn" type="button" data-action="menu" aria-expanded="false" aria-controls="site-nav">Меню</button>
        <button class="btn" type="button" data-action="theme" aria-label="Переключить тему">Тема</button>
      </div>
    </div>
  </header>

  <main id="main" class="container">
    <section class="hero">
      <p class="h-sub"><a class="underline" href="/contacts/">← Назад</a></p>
      <h1 class="h-title">Импорт Excel/CSV → data/tos.data.js</h1>
      <p class="h-sub">Инструмент работает прямо в браузере. Ничего никуда не отправляет. Использует библиотеку SheetJS через CDN.</p>
    </section>

    <section class="grid">
      <div class="card"><div class="card-inner prose">
        <h2>1) Выберите файл</h2>
        <input class="input" id="file" type="file" accept=".xlsx,.xls,.csv"/>
        <p><small>Если вы офлайн и CDN не открывается — импорт не сработает. В таком случае можно экспортировать CSV и править руками.</small></p>

        <h2>2) Получите результат</h2>
        <button class="btn primary" id="btn" type="button">Сгенерировать tos.data.js</button>
        <p><small>Ожидаемые колонки (можно переименовать в вашем файле):<br/>
          Название, Населенный пункт/микрорайон, Границы, Год создания, ФИО председателя, Контакты, Ссылки, Кол-во жителей, Описание.</small></p>
      </div></div>

      <div class="card"><div class="card-inner prose">
        <h2>Готовый код</h2>
        <textarea class="input" id="out" style="min-height:520px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;"></textarea>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button class="btn" id="copy" type="button">Скопировать</button>
          <a class="btn" href="/data/tos.data.js" target="_blank" rel="noopener">Открыть текущий tos.data.js</a>
        </div>
      </div></div>
    </section>
  </main>

  <footer class="footer"><div class="container"><div class="tiny">Инструмент — часть репозитория. Можно удалять, если не нужен.</div></div></footer>

  <script src="/assets/js/site.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    (function(){
      function slugifyRu(s){
        const map = {"а":"a","б":"b","в":"v","г":"g","д":"d","е":"e","ё":"e","ж":"zh","з":"z","и":"i","й":"y","к":"k","л":"l","м":"m","н":"n","о":"o","п":"p","р":"r","с":"s","т":"t","у":"u","ф":"f","х":"h","ц":"ts","ч":"ch","ш":"sh","щ":"sch","ъ":"","ы":"y","ь":"","э":"e","ю":"yu","я":"ya"};
        s = String(s||"").trim().toLowerCase();
        let out = "";
        for(const ch of s){
          if(/[a-z0-9]/.test(ch)) out += ch;
          else if(/[а-яё]/.test(ch)) out += (map[ch] || "");
          else out += "-";
        }
        out = out.replace(/-{2,}/g,"-").replace(/^-|-$/g,"");
        return out || "tos";
      }

      const file = document.getElementById("file");
      const btn = document.getElementById("btn");
      const out = document.getElementById("out");
      const copy = document.getElementById("copy");

      function pick(row, keys){
        for(const k of keys){
          if(row[k] != null && String(row[k]).trim() !== "") return row[k];
        }
        return "";
      }

      btn.addEventListener("click", async ()=>{
        if(!file.files || !file.files[0]){ alert("Выберите файл."); return; }
        const f = file.files[0];
        const data = await f.arrayBuffer();
        const wb = XLSX.read(data, { type: "array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

        const items = [];
        const used = new Set();

        rows.forEach((r, idx)=>{
          const name = String(pick(r, [
            "Название вашего ТОС (Без ТОС и кавычек, с большой буквы)",
            "Название ТОС","Название","name"
          ])).trim();

          if(!name) return;

          let id = slugifyRu(name);
          if(used.has(id)) id = id + "-" + (idx+1);
          used.add(id);

          const item = {
            id,
            name,
            place: String(pick(r, ["Населенный пункт или микрорайон","Населенный пункт","Микрорайон","place"])).trim(),
            type: String(pick(r, ["Тип","type"])).trim(), // заполняйте вручную: "Городской" / "Сельский"
            boundaries: String(pick(r, ["Границы ТОС ( Укажите улицы, кварталы или дома, входящие в ТОС.)","Границы ТОС","boundaries"])).trim(),
            founded: Number(String(pick(r, ["Год создания ТОС","Год создания","founded"])).replace(/\D/g,"")) || null,
            chair: String(pick(r, ["ФИО Председателя","Председатель","chair"])).trim(),
            contacts: String(pick(r, ["Контакты председателя (телефон, соц. сети, почта)","Контакты","contacts"])).trim(),
            social_links: String(pick(r, ["Ссылки на группы ТОСа","Ссылки","social_links"])).trim(),
            residents: Number(String(pick(r, ["Примерное количество жителей в ТОС","Количество жителей","residents"])).replace(/\D/g,"")) || null,
            description: String(pick(r, ["Расскажите несколько предложений о своем ТОС","Описание","description"])).trim(),
            logo: "",
            geo: null
          };

          items.push(item);
        });

        const js = "window.DATA = window.DATA || {};\nwindow.DATA.tos = " + JSON.stringify(items, null, 2) + ";\n";
        out.value = js;
      });

      copy.addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(out.value);
          copy.textContent = "Скопировано";
          setTimeout(()=>copy.textContent="Скопировать", 1200);
        }catch(e){
          alert("Не удалось скопировать. Выделите текст вручную и нажмите Ctrl+C.");
        }
      });
    })();
  </script>
</body>
</html>
